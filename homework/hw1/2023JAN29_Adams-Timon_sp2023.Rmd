---
title: " Modern Data Mining, HW 1"
author:
- Group Member 1 Jenea Adams
- Group Member 2 Annan timon
- Group Member 3
date: 'Due: 11:59PM,  Jan. 29th, 2023'
output:
  html_document:
    code_folding: show
    highlight: haddock
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: '4'
  word_document:
    toc: yes
    toc_depth: '4'
urlcolor: blue
---

# Packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "hide", fig.width=8, fig.height=6)
options(scipen = 0, digits = 3)  # controls base R output
# check if you have ISLR package, if not, install it
if(!require('pacman')) {install.packages('pacman')}
pacman::p_load(ISLR, readxl, tidyverse, magrittr, dplyr, ggplot2,readxl,reshape2, ggpmisc, knitr, ggpubr, gridExtra)
```




\pagebreak

# Overview

This is a fast-paced course that covers a lot of material. There will be a large amount of references. You may need to do your own research to fill in the gaps in between lectures and homework/projects. It is impossible to learn data science without getting your hands dirty. Please budget your time evenly. Last-minute work ethic will not work for this course. 

Homework in this course is different from your usual homework assignment as a typical student. Most of the time, they are built over real case studies.  While you will be applying methods covered in lectures, you will also find that extra teaching materials appear here.  The focus will be always on the goals of the study, the usefulness of the data gathered, and the limitations in any conclusions you may draw. Always try to challenge your data analysis in a critical way. Frequently, there are no unique solutions. 

Case studies in each homework can be listed as your data science projects (e.g. on your CV) where you see fit. 



## Objectives 

- Get familiar with `R-studio` and `RMarkdown`
- Hands-on R 
- Learn data science essentials 
    - gather data
    - clean data
    - summarize data 
    - display data
    - conclusion
- Packages
    - `dplyr`
    - `ggplot`

##  Instructions

- **Homework assignments can be done in a group consisting of up to three members**. Please find your group members as soon as possible and register your group on our Canvas site.

- **All work submitted should be completed in the R Markdown format.** You can find a cheat sheet for R Markdown [here](https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf) For those who have never used it before, we urge you to start this homework as soon as possible. 

- **Submit the following files, one submission for each group:**  (1) Rmd file, (2) a compiled  HTML or pdf version, and (3) all necessary data files if different from our source data. You may directly edit this .rmd file to add your answers. If you intend to work on the problems separately within your group, compile your answers into one Rmd file before submitting. We encourage that you at least attempt each problem by yourself before working with your teammates. Additionally, ensure that you can 'knit' or compile your Rmd file. It is also likely that you need to configure Rstudio to properly convert files to PDF. [**These instructions**](http://kbroman.org/knitr_knutshell/pages/latex.html#converting-knitrlatex-to-pdf) might be helpful.

- In general, be as concise as possible while giving a fully complete answer to each question. All necessary datasets are available in this homework folder on Canvas. Make sure to document your code with comments (written on separate lines in a code chunk using a hashtag `#` before the comment) so the teaching fellows can follow along. R Markdown is particularly useful because it follows a 'stream of consciousness' approach: as you write code in a code chunk, make sure to explain what you are doing outside of the chunk. 

- A few good or solicited submissions will be used as sample solutions. When those are released, make sure to compare your answers and understand the solutions.


## Review materials

- Study Basic R Tutorial
- Study Advanced R Tutorial (to include `dplyr` and `ggplot`)
- Study lecture 1: Data Acquisition and EDA


# Case study 1: Audience Size

How successful is the Wharton Talk Show [Business Radio Powered by the Wharton School](https://businessradio.wharton.upenn.edu/)  


**Background:** Have you ever listened to [SiriusXM](https://www.siriusxm.com/)? Do you know there is a **Talk Show** run by Wharton professors in Sirius Radio?  Wharton launched a talk show called [Business Radio Powered by the Wharton School](https://businessradio.wharton.upenn.edu/) through the Sirius Radio station in January of 2014. Within a short period of time the general reaction seemed to be overwhelmingly positive. To find out the audience size for the show, we designed a survey and collected a data set via MTURK in May of 2014. Our goal was to **estimate the audience size**. There were 51.6 million Sirius Radio listeners then. One approach is to estimate the proportion of the Wharton listeners to that of the Sirius listeners, $p$, so that we will come up with an audience size estimate of approximately 51.6 million times $p$. 

To do so, we launched a survey via Amazon Mechanical Turk ([MTurk](https://www.mturk.com/)) on May 24, 2014 at an offered price of \$0.10 for each answered survey.  We set it to be run for 6 days with a target maximum sample size of 2000 as our goal. Most of the observations came in within the first two days. The main questions of interest are "Have you ever listened to Sirius Radio" and "Have you ever listened to Sirius Business Radio by Wharton?". A few demographic features used as control variables were also collected; these include Gender, Age and Household Income.  

We requested that only people in United States answer the questions. Each person can only fill in the questionnaire once to avoid duplicates. Aside from these restrictions, we opened the survey to everyone in MTurk with a hope that the sample would be more randomly chosen. 

The raw data is stored as `Survey_results_final.csv` on Canvas.


## Data preparation

### We need to clean and select only the variables of interest. 

+ Select only the variables Age, Gender, Education Level, Household Income in 2013, Sirius Listener?, Wharton Listener?
and Time used to finish the survey.

```{r, include=FALSE}
setwd("./data")
survey = read.csv("Survey_results_final.csv")
```
```{r}
names(survey)
```

```{r, include=FALSE}
survey.sub = survey %>%
  select(Answer.Age, Answer.Gender, Answer.Education, Answer.HouseHoldIncome , Answer.Sirius.Radio, Answer.Wharton.Radio, WorkTimeInSeconds)
```



+ Change the variable names to be "age", "gender", "education", "income", "sirius", "wharton", "worktime".


```{r}
colnames(survey.sub) = c("age", "gender", "education", "income", "sirius", "wharton", "worktime")
survey.sub
```


### Handle missing/wrongly filled values of the selected variables

As in real world data with user input, the data is incomplete, with missing values, and has incorrect responses. There is no general rule for dealing with these problems beyond “use common sense.” In whatever case, explain what the problems were and how you addressed them. Be sure to explain your rationale for your chosen methods of handling issues with the data. Do not use Excel for this, however tempting it might be.

Tip: Reflect on the reasons for which data could be wrong or missing. How would you address each case? For this homework, if you are trying to predict missing values with regression, you are definitely overthinking. Keep it simple.

```{r examine age, echo=FALSE}
# coerce to numeric 
summary(as.factor(survey.sub$age))

# 4 people did not respond and 2 people selected an incorrect age, remove these responses

```

```{r examine gender, echo=FALSE}
# coerce to factor 
survey.sub$gender %>% as.factor(.) %>% summary(.)

# 6 people did not respond, will remove these
```

```{r examine education, echo=FALSE}
education <- survey.sub$education %>% as.factor(.)
summary(education)

# 19 people selected the invalid response "select one" will chage these responses to 'other'
summary(education)
```

```{r examine income, echo=FALSE}
# coerce to factor 
survey.sub$income %>% as.factor(.) %>% summary(.)

# 6 people did not respond, will remove these
```

```{r examine sirius, echo=FALSE}
# coerce to factor 
survey.sub$sirius %>% as.factor(.) %>% summary(.)
```

```{r examine wharton, echo=FALSE}
# coerce to factor 
survey.sub$wharton %>% as.factor(.) %>% summary(.)

# remove everyone who did not answer this question
# remove everyone who said no to sirius and yes to wharton
```

```{r examine worktime, echo=FALSE}
survey.sub$worktime %>% summary(.)

# this section is fine and doesn't need change
```

```{r, echo=FALSE}

missing.survey <- data.frame(rbind("Missing or NA Values" = apply(survey.sub,2,
                                                                  FUN=function(y){sum(is.na(y) | y=='')}),
                                   "Incorrect Values" = apply(survey.sub,2, FUN=function(y){
                                     sum(y %in% c('select one',"female",
                                                  "Eighteen (18)","27`",
                                                  "223", "4"))})))
sum(missing.survey)
missing.survey
```

#### **Summary of missing values**
Before this point, we thought there were just blanks and NAs in the data, but discovered there were unchanged entire fields in the form os "select one" for at least the education column and incorrect values in the age column. Here we tabulate these missing entries. 

```{r, echo=FALSE, results='asis'}
kable(missing.survey,
      caption = "Breakdown of Missing and Incorrect Values")
```

* Within the `age` variable, 1 person did not respond, 2 people selected ages that did not make sense in the context of the survey (4 and 223), and 2 people wrote their age as a character "eighteen (18)", "27`", and female. We opted to remove the missing responses, and the incorrect ages; however, for the values "eighteen (18)" and "27'", we changed these to their numeric values.

* Within the `education` variable, 19 selected 'select one' and we opted to remove these

* Within the `gender`, `income`, `wharton`, and `sirius` variables, we removed all missing values.

* We did not remove any values from the `worktime` variable since it did not contain any missing or incorrect values.


```{r, echo=FALSE}
# change value of wrong age values

blanks =  survey.sub %>%
  filter((age %in% c("","female", "223", "4"))| gender == "" | education == "" | education == "select one" | income == ""| sirius == "" | wharton == "" | worktime == "")

dim(blanks)
```
Although there we remove 44 total (22 missing and 22 incorrect values) only 37 surveys are removed because some people have multiple variables missing. 



```{r, echo=FALSE, warning=FALSE}
dim(survey.sub)

# correct age values
age <- survey.sub$age 
age[age == "Eighteen (18)"] <-  18
age[age == "27`"] <-  27
age <- as.numeric((age))
survey.sub$age <- age

# remove nas, missing, and incorrect education values
survey.sub.pruned = survey.sub %>%
  filter(!is.na(age) & !(age %in% c(4,223)) & !gender == "" & !education == "" & !education == "select one" & !income == ""& !sirius == "" & !wharton == "" & !worktime == "")
dim(survey.sub.pruned)

summary(survey.sub.pruned)

```


## Brief summary 

Write a brief report to summarize all the variables collected. Include both summary statistics (including sample size) and graphical displays such as histograms or bar charts where appropriate. Comment on what you have found from this sample. (For example - it's very interesting to think about why would one work for a job that pays only 10cents/each survey? Who are those survey workers? The answer may be interesting even if it may not directly relate to our goal.)

```{r}
#refactor certain columns
survey.sub.pruned$income <- factor(survey.sub.pruned$income,
                                     levels = c("Less than $15,000",
                                                "$15,000 - $30,000",
                                                "$30,000 - $50,000",
                                                "$50,000 - $75,000",
                                                "$75,000 - $150,000",
                                                "Above $150,000"))

survey.sub.pruned$education <- factor(survey.sub.pruned$education,
                                         levels = c("Other",
                                                "Less than 12 years; no high school diploma",
                                                "High school graduate (or equivalent)",
                                                "Some college, no diploma; or Associate’s degree",
                                                "Bachelor’s degree or other 4-year degree",
                                                "Graduate or professional degree"))

survey.sub.pruned$gender <- as.factor(survey.sub.pruned$gender)
survey.sub.pruned$sirius <- as.factor(survey.sub.pruned$sirius)
survey.sub.pruned$wharton <- as.factor(survey.sub.pruned$wharton)

```

This study received 1,764 surveys. We removed 37 of those after conductiong quality control, resulting in a total of 1,727 surveys. In general, the participants are mostly young, ranging from early to late twenties. Most are Male. The majority have at least attended some college and make mkae below 50,000 dollars. We describe the population of participants in greater detail and by several demographic categories below.

### Age 

* age ranges from 18-76

* It is right skewed, with most participants being younger in their early to late twenties

We can see the distribution of ages with a histogram and examine how this distribution is distributed by other variables


```{r, warning=FALSE, results='asis'}
age_hist <- survey.sub.pruned %>%
  ggplot() + 
  geom_histogram(aes(x = age), bins = 30, color ="darkblue", fill = "lightblue") + 
  labs(title = "Historgram of age", subtitle = "Mean Age shown by red line", x = "Age (years)", y = "frequency") +
  geom_vline(aes(xintercept=mean(age)),
             color = "red", linetype = "dashed", sixe = 1)


age_gender <- ggplot(survey.sub.pruned) +
  geom_boxplot(aes(y=age, x= gender, fill=gender),
                  position="identity")  +
  labs(title = "Participant Age by Gender", y = "Age (years)", x ='Gender') +
  scale_fill_brewer(palette="Reds")+ 
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

age_income <- ggplot(survey.sub.pruned) +
  geom_boxplot(aes(y=age,x= income, fill=income),
                  position="identity")  +
  labs(title = "Participant Age by Income", y = "Age (years)", x ='Income') +
  scale_fill_brewer(palette="Reds")+ 
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

age_education <- ggplot(survey.sub.pruned) +
  geom_boxplot(aes(y=age, x= education, fill=education),
                  position="identity") +
  labs(title = "Participant Age by Education", y = "Age (years)", x ='Education') +
  scale_fill_brewer(palette="Reds") + 
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#grid.arrange(age_hist, age_gender, age_income, age_education, ncol = 2)
age_hist
```


### Gender 

* There are 729 (42%) Females and 998 (58%) Males in the survey pool.
```{r}
# >>>>>>> 5d0ed39005b074bcca1f3ccdd3eab194461fdea9
summary(survey.sub.pruned)
str(survey.sub.pruned)
```
```{r}
table(survey.sub.pruned$gender)
```

```{r, fig.dim = c(8, 9)}
gender_pie <-  survey.sub.pruned %>%
  ggplot(aes(x = "", y = gender, fill = gender)) + 
  geom_bar(stat ="identity", width = 1) + 
  coord_polar("y", start=0) + 
  theme_void()

#gender_hist
gender_histogram <- survey.sub.pruned %>%
  summarise(pct = summary(gender)/length(gender),
            gender = levels(gender)) %>%
  ggplot(aes(x=gender, y=pct, fill=gender))+
  geom_bar(stat= "identity")  +
  geom_text(aes(label = scales::percent(pct)), vjust = -.25) +
  labs(title = "Participants by Gender", y = "Percent", x ='Gender') +
  theme_minimal()

grid.arrange(gender_pie, gender_histogram, ncol = 2)
```

### Education 

Most participants have completed some college education.

```{r, results='asis'}
edu_table <- data.frame("Counts" = summary(survey.sub.pruned$education),
                        "Percentage" = (summary(survey.sub.pruned$education)/length(survey.sub.pruned$education))*100)
kable(edu_table,
      caption = "Survey Demographics by education")
```

```{r}
edu_pie <- survey.sub.pruned %>%
  ggplot(aes(x = "", y = education, fill = education)) + 
  geom_bar(stat ="identity", width = 1) + 
  coord_polar("y", start=0) + 
  theme_void()
```


```{r}

  # theme_void() + # phantom section? 
  # theme(legend.position="none")
  

edu_hist <- survey.sub.pruned %>%
  summarise(pct = summary(education)/length(education),
            education= levels(education)) %>%
  mutate(education = factor(education,
                            levels = c("Other",
                               "Less than 12 years; no high school diploma",
                               "High school graduate (or equivalent)",
                               "Some college, no diploma; or Associate’s degree",
                               "Bachelor’s degree or other 4-year degree",
                               "Graduate or professional degree"))) %>%

ggplot(aes(x=education,y=pct, fill=education))+
  geom_bar(stat= "identity")  +
  geom_text(aes(label = scales::percent(pct)), vjust = -.5) +
  labs(title = "Participants by Education", y = "Percent", x ='Highest Degree') +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```


```{r, echo = FALSE,message=FALSE,fig.height=10, fig.width=12, results='asis'}
# grid.arrange(edu_pie, edu_hist, nrow = 2, ncol = 1,
#         axis.ticks.x=element_blank(),
#         legend.position="bottom",
#         legend.key.size = unit(1, 'mm'),
#         legend.text = element_text(size=5),
#         legend.title = element_text(size=6))


grid.arrange(edu_hist, edu_pie, ncol = 1, nrow =2)

```

### Income

Most participants make below $50,000

```{r, results='asis'}
inc_table <- data.frame("Counts" = summary(survey.sub.pruned$income),
                        "Percentage" = (summary(survey.sub.pruned$income)/length(survey.sub.pruned$income))*100)
kable(inc_table,
      caption = "Survey Demographics by Income")
```


```{r }
# income
income_pie = survey.sub.pruned %>%
  ggplot(aes(x = "", y = income, fill = income)) + 
  geom_bar(stat ="identity", width = 1) + 
  coord_polar("y", start=0) + 
  theme_void() +
  theme(legend.position="none")


income_hist <- survey.sub.pruned %>%
  summarise(pct = summary(income)/length(income),
            income= levels(income)) %>%
  mutate(income = factor(income,
                         levels = c("Less than $15,000",
                                                "$15,000 - $30,000",
                                                "$30,000 - $50,000",
                                                "$50,000 - $75,000",
                                                "$75,000 - $150,000",
                                                "Above $150,000"))) %>%
ggplot(aes(x=income,y=pct, fill=income))+
  geom_bar(stat= "identity")  +
  geom_text(aes(label = scales::percent(pct)), vjust = -.5) +
  labs(title = "Participants by income", y = "Percent", x ='Highest Degree') +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position="bottom",
        legend.key.size = unit(1, 'mm'),
        legend.text = element_text(size=7),
        legend.title = element_text(size=7))


grid.arrange(income_hist, income_pie, ncol = 2)

```

### Sirius Listeners

* 77% of participants listen to Sirius Radio

```{r sirius plots}

sirius_pie = survey.sub.pruned %>%
  ggplot(aes(x = "", y = sirius, fill = sirius)) + 
  geom_bar(stat ="identity", width = 1) + 
  coord_polar("y", start=0) + 
  theme_void()


sirius_hist <- survey.sub.pruned %>%
  summarise(pct = summary(sirius)/length(sirius),
            sirius= levels(sirius)) %>%
ggplot(aes(x=sirius,y=pct, fill=sirius))+
  geom_bar(stat= "identity")  +
  geom_text(aes(label = scales::percent(pct)), vjust = -.5) +
  labs(title = "Participants Who listen to SiriusXM Radio", y = "Percent", x ='Highest Degree') +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

grid.arrange(sirius_pie, sirius_hist, ncol = 2)

```
### Business Radio Powered by the Wharton School Listeners

* 4% of participants listen to Business Radio Powered by the Wharton School

```{r wharton plots}

wharton_pie = survey.sub.pruned %>%
  ggplot(aes(x = "", y = wharton, fill = wharton)) + 
  geom_bar(stat ="identity", width = 1) + 
  coord_polar("y", start=0) + 
  theme_void()

wharton_hist <- survey.sub.pruned %>%
  summarise(pct = summary(wharton)/length(wharton),
            wharton= levels(wharton)) %>%
ggplot(aes(x=wharton,y=pct, fill=wharton))+
  geom_bar(stat= "identity")  +
  geom_text(aes(label = scales::percent(pct)), vjust = -.5) +
  labs(title = "Participants Who Listen to Business Radio Powered by the Wharton School", y = "Percent", x ='Highest Degree') +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

grid.arrange(wharton_pie, wharton_hist, ncol = 2)
```

### Worktime

* average worktime 22.5 seconds
* ranged from 8-108 seconds

```{r age worktime, warning=FALSE}

worktime_boxplot = survey.sub.pruned %>%
  ggplot() + 
  geom_boxplot(aes(x = "", y = worktime)) + 
  labs(title = "Boxplot of worktime in seconds", x = "")


# plot looking at worktime total
worktime_hist <- ggplot(survey.sub.pruned) +
  geom_histogram( aes(x=worktime, y = ..density..),
                  bins=30, color ="darkblue", fill = "lightblue", position="identity")  + 
  labs(title = "Histogram of worktime in seconds", x = "",
       subtitle = "Mean Worktime shown by red line", x = "Worktime (seconds)", y = "Percentage") +
  geom_vline(aes(xintercept=mean(worktime)),
             color = "red", linetype = "dashed", sixe = 1)
grid.arrange(worktime_boxplot, worktime_hist, ncol = 2)
```


## Sample properties

The population from which the sample is drawn determines where the results of our analysis can be applied or generalized. We include some basic demographic information for the purpose of identifying sample bias, if any exists. Combine our data and the general population distribution in age, gender and income to try to characterize our sample on hand.

1. Does this sample appear to be a random sample from the general population of the USA?

2. Does this sample appear to be a random sample from the MTURK population?

Note: You can not provide evidence by simply looking at our data here. For example, you need to find distribution of education in our age group in US to see if the two groups match in distribution. You may need to gather some background information about the MTURK population to have a slight sense if this particular sample seem to a random sample from there... Please do not spend too much time gathering evidence. 

We use several datasets from the from the US Census Bureau

* `nc-est2019-sr11h`: Annual Estimates of the Resident Population by Sex, Race, and Hispanic Origin for the United States: April 1, 2010 toJuly 1, 2019	

* `nc-est2019-agesex`: Annual Estimates of the Resident Population for Selected Age Groups by Sex for the United States: April 1, 2010 to July 1, 2019	

* `data/table-1-01.xlsx`: Table 1.  Educational Attainment of the Population 18 Years and Over, by Age, Sex, Race, and Hispanic Origin:  2014

* `data/hinc01R_1.xls`: HINC-01. Selected Characteristics of Households, by Total Money Income in 2013. (income data comes from 2013)

### Gender
Is the distribution of gender from the survey participants a random sample from the general population of the USA?

Additionally we use data from [this paper](https://psyarxiv.com/jbc9d/) that sample from a total of 2,026 U.S. adults in mid-December 2019 in the MTURK database to estimate the demographic information of participants in MTURK


```{r US census Bureau data: sex, warning=FALSE, fig.height=10, fig.width=12}
# US census bureau data
# nc-est2019-sr11h in ./data
female_count <- 161646584
male_count <- 156654424
us_gender_2014 <- data.frame("gender" = c("Male", "Female"),
                             "pct" = c(male_count/(male_count+female_count),
                                       female_count/(male_count+female_count)))

mturk_gender_df <- data.frame("gender" = c("Male", "Female", "Other"),
                             "pct" = c(.4327,
                                       .5644,
                                       0.0030))


# plot looking at gender
survey_gender <- ggplot(survey.sub.pruned, aes(x=gender, fill=gender))+
  geom_bar(aes(y = (..count..)/sum(..count..)))  +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = ((..count..)/sum(..count..))), stat= "count", vjust = -.5) +
  labs(title = "Participants by Gender", y = "Percent", x ='Gender') +
  theme_minimal() +
  scale_fill_brewer(palette="Greens")

us_gender <- ggplot(us_gender_2014, aes(x=gender, y=pct, fill=gender))+
  geom_bar(stat= "identity")  +
  geom_text(aes(label = scales::percent(pct),
                y= pct, stat= "count", vjust = -.5)) +
  labs(title = "US census by Gender 2014", y = "Percent", x ='Gender') +
  theme_minimal() +
  scale_fill_brewer(palette="Greens")

mturk_gender <- ggplot(mturk_gender_df, aes(x=gender, y=pct, fill=gender))+
  geom_bar(stat= "identity")  +
  geom_text(aes(label = scales::percent(pct),
                y= pct, stat= "count", vjust = -.5)) +
  labs(title = "MTURK Gender", y = "Percent", x ='Gender') +
  theme_minimal() +
  scale_fill_brewer(palette="Greens")

grid.arrange(us_gender, survey_gender, mturk_gender, ncol = 2)
```

### Age
Is the distribution of ages from the survey participants a random sample from the general population of the USA?

```{r US census Bureau data: age, warning=FALSE, fig.height=10, fig.width=12, results='asis', message=FALSE}

# mturk age

mturk_age <- data.frame("age" = factor(c("18-29", "30-39",
                                         "40-49", "50-59",
                                         "60-69", "70+")),
                        "pct" = c(.3245, .3405,
                                         .1617, .1072,
                                         .0511, .0150))

# US census bureau data

us_census_age_values <- read_excel("data/nc-est2019-agesex.xlsx", range = "T7:T24", col_names = FALSE)
us_census_age_categories <- gsub('.','',
                                 read_excel("data/nc-est2019-agesex.xlsx",
                                            range = "A7:A24", col_names = FALSE)[[1]],
                                 fixed = TRUE)
us_census_age <- data.frame("ranges" = gsub('.','',us_census_age_categories, fixed = TRUE),
                       "count" = us_census_age_values[[1]],
                       "pct" = us_census_age_values[[1]]/sum(us_census_age_values[[1]]))
#head(us_census_age)
#names(us_census_age)
#us_census_age$ranges

survey_age <- data.frame("age" = c("Under 5 years" = 0,
                                         "5 to 9 years"= 0,
                                         "10 to 14 years"= 0,
                                         "15 to 19 years" = sum(survey.sub.pruned$age < 19),
                                         "20 to 24 years" = sum(survey.sub.pruned$age > 19 &
                                                                survey.sub.pruned$age < 25),
                                         "25 to 29 years" = sum(survey.sub.pruned$age > 24 &
                                                                survey.sub.pruned$age < 30),
                                         "30 to 34 years" = sum(survey.sub.pruned$age > 29 &
                                                                survey.sub.pruned$age < 35),
                                         "35 to 39 years" = sum(survey.sub.pruned$age > 34 &
                                                                survey.sub.pruned$age < 40),
                                         "40 to 44 years" = sum(survey.sub.pruned$age > 39 &
                                                                survey.sub.pruned$age < 45),
                                         "45 to 49 years" = sum(survey.sub.pruned$age > 44 &
                                                                survey.sub.pruned$age < 50),
                                         "50 to 54 years"= sum(survey.sub.pruned$age > 49 &
                                                                survey.sub.pruned$age < 55),
                                         "55 to 59 years" = sum(survey.sub.pruned$age > 54 &
                                                                survey.sub.pruned$age < 60),
                                         "60 to 64 years" = sum(survey.sub.pruned$age > 59 &
                                                                survey.sub.pruned$age < 65),
                                         "65 to 69 years" = sum(survey.sub.pruned$age > 64 &
                                                                survey.sub.pruned$age < 70),
                                         "70 to 74 years" = sum(survey.sub.pruned$age > 69 &
                                                                survey.sub.pruned$age < 75),
                                         "75 to 79 years" = sum(survey.sub.pruned$age > 74 &
                                                                survey.sub.pruned$age < 80),
                                         "80 to 84 years" = sum(survey.sub.pruned$age > 79 &
                                                                survey.sub.pruned$age < 85),
                                         "85 years and over" = sum(survey.sub.pruned$age > 84)))

survey_age <- data.frame("ranges" = rownames(survey_age),
                         "count"=survey_age$age,
                         "pct"=survey_age$age/sum("count"=survey_age$age))

survey_age$ranges <- factor(survey_age$ranges,
                                     levels = c("Under 5 years","5 to 9 years",
                                                "10 to 14 years","15 to 19 years",
                                                "20 to 24 years","25 to 29 years",
                                                "30 to 34 years","35 to 39 years",
                                                "40 to 44 years","45 to 49 years",
                                                "50 to 54 years","55 to 59 years",
                                                "60 to 64 years","65 to 69 years",
                                                "70 to 74 years","75 to 79 years",
                                                "80 to 84 years","85 years and over"))
us_census_age$ranges <- factor(us_census_age$ranges,
                                     levels = c("Under 5 years","5 to 9 years",
                                                "10 to 14 years","15 to 19 years",
                                                "20 to 24 years","25 to 29 years",
                                                "30 to 34 years","35 to 39 years",
                                                "40 to 44 years","45 to 49 years",
                                                "50 to 54 years","55 to 59 years",
                                                "60 to 64 years","65 to 69 years",
                                                "70 to 74 years","75 to 79 years",
                                                "80 to 84 years","85 years and over"))

plot_survey_age <- ggplot(survey_age, aes(x=ranges, y=pct, fill = ranges))+
  geom_bar(stat= "identity")  +
  labs(title = "Survey Age", y = "Percent", x ='Age Groups') +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position="bottom",
        legend.key.size = unit(1, 'mm'),
        legend.text = element_text(size=10),
        legend.title = element_text(size=10))

plot_us_age <- ggplot(us_census_age, aes(x=ranges, y=pct, fill = ranges))+
  geom_bar(stat= "identity")  +
  labs(title = "US Census Age", y = "Percent", x ='Age Groups') +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position="bottom",
        legend.key.size = unit(1, 'mm'),
        legend.text = element_text(size=10),
        legend.title = element_text(size=10))

plot_mturk_age <- ggplot(mturk_age, aes(x=age, y=pct, fill = age))+
  geom_bar(stat= "identity")  +
  labs(title = "MTURK Age", y = "Percent", x ='Age Groups') +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

grid.arrange(plot_us_age, plot_mturk_age, plot_survey_age, ncol = 2)
```
### Education
Is the distribution of education from the survey participants a random sample from the general population of the USA?



```{r US census Bureau data: education, warning=FALSE, fig.height=10, fig.width=12, results='asis'}
# US census bureau data

us_census_education <- read_excel("data/table-1-01.xlsx", range = "C6:Q21")[-1,]
#names(us_census_education)
us_education_2014 <- data.frame("count" = c("Other"= 0,
                                             "Less than 12 years; no high school diploma"=
                                                 sum(us_census_education[,c(1:7)]),
                                             "High school graduate (or equivalent)"=
                                                 sum(us_census_education$`High school graduate`),
                                             "Some college, no diploma; or Associate’s degree"=
                                                 sum(us_census_education[,c(9:11)]),
                                             "Bachelor’s degree or other 4-year degree"=
                                                 sum(us_census_education$`Bachelor's degree`),
                                             "Graduate or professional degree"=
                                                 sum(us_census_education[,c(13:15)])))
us_education_2014$education <- factor(rownames(us_education_2014),
                                     levels = c("Other",
                                                "Less than 12 years; no high school diploma",
                                                "High school graduate (or equivalent)",
                                                "Some college, no diploma; or Associate’s degree",
                                                "Bachelor’s degree or other 4-year degree",
                                                "Graduate or professional degree"))
us_education_2014$pct <- us_education_2014$count/sum(us_education_2014$count)


mturk_eduction_df <-  data.frame("education" = factor(c("No college degree",
                                                  "Associate degree",
                                                  "Bachelor’s degree",
                                                  "Graduate degree"),
                                                  levels = c("No college degree",
                                                             "Associate degree",
                                                             "Bachelor’s degree",
                                                             "Graduate degree")),
                                 "pct" = c(.3762, .1292,
                                           .3450, .1496))


plot_us_education <- ggplot(us_education_2014, aes(x=education, y=pct, fill=education))+
  geom_bar(stat= "identity")  +
  geom_text(aes(label = scales::percent(pct), vjust = -.5)) +
  labs(title = "US Education 2014", y = "Percent", x ='Highest Degree', fill="Highest Degree") +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position="bottom",
        legend.key.size = unit(1, 'mm'),
        legend.text = element_text(size=7),
        legend.title = element_text(size=7))

plot_mturk_education <- ggplot(mturk_eduction_df, aes(x=education, y=pct, fill = education))+
  geom_bar(stat= "identity")  +
  labs(title = "MTURK Education", y = "Percent", x ='Education') +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

grid.arrange(plot_us_education, edu_hist, plot_mturk_education,ncol = 2)
```

### Income
Is the distribution of income from the survey participants a random sample from the general population of the USA?



```{r US census Bureau data: Income, warning=FALSE , fig.height=10, fig.width=12, results='asis'}
# US census bureau data
# https://www.census.gov/data/tables/time-series/demo/income-poverty/cps-hinc/hinc-01.2013.html#list-tab-HKAIF65SA26ZC3YMQB
us_income_2013_excel <- read_excel("data/hinc01R_1.xls", range = "C8:AQ10")[2,]
#names(us_income_2013_excel)
us_income_2013 <- data.frame("count" = c("Less than $15,000"= sum(us_income_2013_excel[,c(1:3)]),
                                          "$15,000 - $30,000"= sum(us_income_2013_excel[,c(4:6)]),
                                          "$30,000 - $50,000"= sum(us_income_2013_excel[,c(7:10)]),
                                          "$50,000 - $75,000"= sum(us_income_2013_excel[,c(11:15)]),
                                          "$75,000 - $150,000"= sum(us_income_2013_excel[,c(16:30)]),
                                          "Above $150,000"= sum(us_income_2013_excel[,c(30:41)])))

us_income_2013$income <- factor(rownames(us_income_2013),
                                     levels = c("Less than $15,000",
                                                "$15,000 - $30,000",
                                                "$30,000 - $50,000",
                                                "$50,000 - $75,000",
                                                "$75,000 - $150,000",
                                                "Above $150,000"))
us_income_2013$pct <- us_income_2013$count/sum(us_income_2013$count)

mturk_income_df <- data.frame("income" = factor(c("$10k-$19,999", "$20k-$29,999",
                                                  "$30k-$39,999", "$40k-$49,999",
                                                  "$50k-$59,999","$60k-$69,999",
                                                  "$70k-$79,999","$80k-$89,999",
                                                  "$90k-$99,999","$100k-$149k",
                                                  ">$150k"),
                                                  levels =c("$10k-$19,999", "$20k-$29,999",
                                                            "$30k-$39,999", "$40k-$49,999",
                                                            "$50k-$59,999","$60k-$69,999",
                                                            "$70k-$79,999","$80k-$89,999",
                                                            "$90k-$99,999","$100k-$149k",
                                                            ">$150k") ),
                                 "pct" = c(.0660,.1167,.1082,.1102,.1122,
                                           .0794,.0730,.0506,.0516,.1197,.0492))


plot_us_income <- ggplot(us_income_2013, aes(x=income, y=pct, fill=income))+
  geom_bar(stat="identity")  +
  geom_text(aes(label = scales::percent(pct)), vjust = -.5) +
  labs(title = "US Household Income 2013", y = "Percent", x ='income', fill="income bracket") +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

plot_mturk_income <- ggplot(mturk_income_df, aes(x=income, y=pct, fill = income))+
  geom_bar(stat= "identity")  +
  geom_text(aes(label = scales::percent(pct)), vjust = -.5, size=3) +
  labs(title = "MTURK Income", y = "Percent", x ='Income') +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

grid.arrange(plot_us_income, income_hist, plot_mturk_income , ncol = 2)
```


1. Does this sample appear to be a random sample from the general population of the USA?
+ This sample slightly differs from the population of the USA in some demographic information, but appears to be a random sample. We would have to do more analysis outside of looking at percentages to quantify the magnitude of the difference
+ The participants completely exclude anyone younger than 18, and the prticipants included are younger than the US population
+ There is a higher percentage of males in this sample (58%) while the US has closer to 50%
+ The participants are more educated, with a larger percentage of participants with some college experience, and a larger percentage with at least a bachelor's degree
+ The income distribution was within a few percentage points of the U.S. population for each income bracket 
except people making more than $150,000 per year.

2. Does this sample appear to be a random sample from the MTURK population?
+ This sample appears to be a random sample of the population from the MTURK population.
+ In both populations, participants included are younger than the US population, varying by a few percentage points
+ There is a higher percentage of males in this sample (58%) while the MTURK has closer to 43%
+ In both populations, the participants are more educated, with a larg percentage of participants with some college experience, and a larger percentage with at least a bachelor's degree
+ The income distribution was within a few percentage points of the MTURK population for each income bracket 
except people making more than $150,000 per year.

## Final estimate

Give a final estimate of the Wharton audience size in January 2014. Assume that the sample is a random sample of the MTURK population, and that the proportion of Wharton listeners vs. Sirius listeners in the general population is the same as that in the MTURK population. Write a brief executive summary to summarize your findings and how you came to that conclusion.

```{r estimating population size}
total_sirius_liteners <- survey.sub.pruned[survey.sub.pruned$sirius == "Yes",]
total_wharton_liteners <- total_sirius_liteners[total_sirius_liteners$wharton == "Yes",]

n <- nrow(total_sirius_liteners)
p <- nrow(total_wharton_liteners)/n
q <- 1 - p

lower_bound <- p - 1.96*sqrt((p*q)/n)
upper_bound <- p + 1.96*sqrt((p*q)/n)
print(paste0("Wharton audience size in January 2014 is between [",
             round(lower_bound*51600000), ", ",
             round(upper_bound*51600000), "]",
             ". Here, we estimate it to be ", round(p*51600000),
             "."))

#pbinom(51600000, prop_listeners)

#rbinom(, size, prob)
```


To be specific, you should include:

1. Goal of the study
2. Method used: data gathering, estimation methods
3. Findings
4. Limitations of the study. 

Wharton launched a talk show called [Business Radio Powered by the Wharton School](https://businessradio.wharton.upenn.edu/) through the Sirius Radio station in January of 2014. To find out the audience size for the show, a survey was designed and collected a data set via MTURK in May of 2014. The goal was to **estimate the audience size**. 

To do so, launched a survey via Amazon Mechanical Turk ([MTurk](https://www.mturk.com/)) was launched on May 24, 2014 at an offered price of \$0.05 for each answered survey.  WIt was set to be run for 6 days with a target maximum sample size of 2000 as the goal. Most of the observations came in within the first two days. The main questions of interest are "Have you ever listened to Sirius Radio" and "Have you ever listened to Sirius Business Radio by Wharton?". A few demographic features used as control variables were also collected; these include Gender, Age and Household Income.

It was requested that only people in United States answer the questions. Each person can only fill in the questionnaire once to avoid duplicates. Aside from these restrictions, the survey was open to everyone in MTurk with a hope that the sample would be more randomly chosen. 

We Assume that the sample is a random sample of the MTURK population, and that the proportion of Wharton listeners vs. Sirius listeners in the general population is the same as that in the MTURK population.

There were 51.6 million Sirius Radio listeners then. One approach is to estimate the proportion of the Wharton listeners to that of the Sirius listeners, $p$, so that we will come up with an audience size estimate of approximately 51.6 million times $p$. **Using this method, we estimated that the Wharton audience size in January 2014 is between [1982330, 3189248], specifically 2,585,789**.

A major limitation of this study is that the population sampled from MTURK is not a random sample of the US population and differs quite significantly.



## New task

Now suppose you are asked to design a study to estimate the audience size of Wharton Business Radio Show as of today: You are given a budget of $1000. You need to present your findings in two months. 

Write a proposal for this study which includes:

1. Method proposed to estimate the audience size.
  - Since we know that most participants have some sort of college experience, we could poll audiences within and adjacent to those speces with a qualtrics survey sent across the country. The incentive to participate would be cash prizes raffled off to the top N participants and/or one year of subscription service to Sirus XM radio. 
  
2. What data should be collected and where it should be sourced from.
- The Data collected should be Age, Education, Gender, Location, Experience with Wharton Radio, How they found out about Wharton Radio. 

Please fill in the google form to list your platform where surveys will be launched and collected [HERE](https://forms.gle/8SmjFQ1tpqr6c4sa8) 

A good proposal will give an accurate estimation with the least amount of money used. 



# Case study 2: Women in Science


Are women underrepresented in science in general? How does gender relate to the type of educational degree pursued? Does the number of higher degrees increase over the years? In an attempt to answer these questions, we assembled a data set (`WomenData_06_16.xlsx`) from [NSF](https://ncses.nsf.gov/pubs/nsf19304/digest/field-of-degree-women) about various degrees granted in the U.S. from 2006 to 2016. It contains the following variables: Field (Non-science-engineering (`Non-S&E`) and sciences (`Computer sciences`, `Mathematics and statistics`, etc.)), Degree (`BS`, `MS`, `PhD`), Sex (`M`, `F`), Number of degrees granted, and Year.

Our goal is to answer the above questions only through EDA (Exploratory Data Analyses) without formal testing. We have provided sample R-codes in the appendix to help you if needed. 


## Data preparation  

Understand and clean the data


Notice the data came in as an Excel file. We need to use the package `readxl` and the function `read_excel()` to read the data `WomenData_06_16.xlsx` into R. 


+ Read the data into R.
```{r}
wsci <- read_excel("data/WomenData_06_16.xlsx")
```



```{r data wrangling, echo = FALSE, warning = FALSE}
names(wsci)
head(wsci)
summary(wsci)
```

```{r}
str(wsci)
```


```{r  echo = FALSE, warning = FALSE}
# change names
# set the field, degree and sex as factors
```


+ Clean the names of each variables. (Change variable names to  `Field`,`Degree`, `Sex`, `Year` and `Number` )
```{r  }
colnames(wsci) = c("Field","Degree", "Sex", "Year", "Number")
```


+ Set the variable natures properly. 
```{r  }
wsci = wsci %>% mutate(Field = as.factor(Field),
         Sex = as.factor(Sex),
         Degree = as.factor(Degree))
```

```{r}
glimpse(wsci)
```


+ Any missing values?

We can count the number of `NA` values, if there are any. In this dataset, there are no missing values.
```{r}
missing = wsci %>%
  summarise(count = sum(is.na(wsci)))
missing

```

## Write a summary describing the data set provided here. 

+ How many fields are there in this data?

```{r summary, echo = FALSE, warning = FALSE}
str(wsci)

summary(wsci$Field)
summary(wsci$Degree)
summary(wsci$Sex)
summary(wsci$Year)
unique(wsci$Year)
length(unique(wsci$Year))
summary(wsci$Number)
```

We can count the amount of unique entries in the Field variable
```{r}
length(unique(wsci$Field))
```

There are 10 Fields possible: Agricultural sciences; Biological sciences; Computer sciences; Earth, atmospheric, and ocean sciences; Engineering; Mathematics and statistics; Non-S&E; Physical sciences; Psychology; and Social sciences 


+ What are the degree types? 

```{r}
unique(wsci$Degree)
```

There are 3 degree types: BS, MS, and PhD 


+ How many year's statistics are being reported here? 

```{r}
length(unique(wsci$Year))
unique(wsci$Year)
```

There are statistics for 11 years from 2006 to 2016

+ Other Variables

Other variables included in this study are Sex, Male or Female, and Number, the number of degrees awarded.

## BS degrees in 2015

Is there evidence that more males are in science-related fields vs `Non-S&E`? Provide summary statistics and a plot which shows the number of people by gender and by field. Write a brief summary to describe your findings.



```{r}
# by field (S&E and Non-S&E) only
p1 = wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = SE, y = SE_number, fill = SE)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label =SE_number), vjust = -.5)  +
  ggtitle("Degrees Awarded by Field (S&E and Non-S&E)")
```


```{r, message=FALSE}
# by sex and field (S&E and Non-S&E)
p2 = wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = Sex, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label =SE_number), vjust = -.5)  +
  facet_wrap(~SE, scales = "free_y") +
  ggtitle("Degrees Awarded by Sex and Field (S&E and Non-S&E)")


```

```{r, fig.height=10, fig.width=12, results='asis'}
ggarrange(p1, p2 + rremove("x.text"),
          labels = c("A", "B"),
          ncol=1, nrow = 2)
```

Is there evidence that more males are in science-related fields vs `Non-S&E`? --> **There are more people overall in Non-S&E fields, in which there are more women. However, there are more men in the S&E fields from these plots.**


## EDA bringing type of degree, field and gender in 2015

Describe the number of people by type of degree, field, and gender. Do you see any evidence of gender effects over different types of degrees? Again, provide graphs to summarize your findings.

```{r eval = FALSE, echo = FALSE}
# # number of degrees by sex
# wsci %>%
#   group_by(Sex) %>%
#   summarise(sex_number = sum(Number)) %>%
#   ggplot(aes(x = Sex, y = sex_number, fill = Sex)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   geom_text(aes(label =sex_number), vjust = -.5)  +
#   ggtitle("Degrees Awarded by Sex") 
# 
# # number of degrees by degree
# wsci %>%
#   group_by(Degree) %>%
#   summarise(degree_number = sum(Number)) %>%
#   ggplot(aes(x = Degree, y = degree_number, fill = Degree)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   geom_text(aes(label =degree_number), vjust = -.5)  +
#   ggtitle("Degrees Awarded by Degree Type") 
# 
# # number of degrees by field
# wsci %>%
#   group_by(Field) %>%
#   summarise(field_number = sum(Number)) %>%
#   ggplot(aes(x = Field, y = field_number, fill = Field)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   geom_text(aes(label =field_number), vjust = -.5)  +
#   ggtitle("Degrees Awarded by Field") 
# 
# # number of degrees by degree and sex
# wsci %>%
#   group_by(Degree, Sex) %>%
#   summarise(degree_number = sum(Number)) %>%
#   ggplot(aes(x = Sex, y = degree_number, fill = Sex)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   geom_text(aes(label =degree_number), vjust = -.5)  +
#   facet_wrap(~Degree, scales = "free_y") +
#   ggtitle("Degrees Awarded Sex and Degree Type") 
# 
# # number of degrees by field and sex
# wsci %>%
#   group_by(Field, Sex) %>%
#   summarise(field_number = sum(Number)) %>%
#   ggplot(aes(x = Sex, y = field_number, fill = Sex)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   geom_text(aes(label =field_number), vjust = -.5)  +
#   facet_wrap(~Field, scales = "free_y") +
#   ggtitle("Degrees Awarded By Sex and Field") 
# 
# # number of degrees by field and degree
# wsci %>%
#   group_by(Field, Degree) %>%
#   summarise(field_number = sum(Number)) %>%
#   ggplot(aes(x = Field, y = field_number, fill =Field)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   geom_text(aes(label =field_number), vjust = -.5)  +
#   facet_wrap(~Degree, scales = "free_y") +
#   ggtitle("Degrees Awarded by Field and Degree Type") 
# 
# 
# # number of degrees by sex and field and degree
# wsci %>%
#   group_by(Field, Sex, Degree) %>%
#   summarise(All_number = sum(Number)) %>%
#   ggplot(aes(x = Sex, y = All_number, fill = Sex)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   facet_grid(Degree~Field, scales = "free_y") +
#   geom_text(aes(label =All_number), vjust = -.5)  +
#   ggtitle("Degrees Awarded by Sex, Field, and Degree Type") 

```



```{r  }
wsci$science.i = ifelse(wsci$Field == "Non-S&E", "Non-S&E", "S&E")
dfg2015 = wsci %>% 
  filter(Year == 2015) %>% 
  select(Degree, Field, Sex, Number, science.i)

```


```{r, fig.height=10, fig.width=12, results='asis'}
dfg2015%>%
  ggplot(aes(x = Field, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Degree~., scales = "free_y") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  ggtitle("Degrees granted across fields by degree and gender in 2015")
```

```{r, fig.height=10, fig.width=12, results='asis'}
dfg2015%>%
  ggplot(aes(x = science.i, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Degree~., scales = "free_y") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  ggtitle("Degrees granted across fields by degree and gender in 2015")
```


**The proportion of non s&e fields and the degree types is relatively the same, but more variability in the s&e degrees. males and females obtain about the same science BS degrees (females slightly more), but males have more science MS and PhDs.**

## EDA bring all variables 

In this last portion of the EDA, we ask you to provide evidence numerically and graphically: Do the number of  degrees change by gender, field, and time? 

```{r eval = FALSE, echo = FALSE}
# time series: degrees awarded by field
# wsci %>%
#   group_by(Field, Year) %>%
#   summarise(field_number = sum(Number)) %>%
#   ggplot(aes(x = Year, y = field_number, color = Field)) +
#   geom_point() + geom_line() +
#   ggtitle("Degrees awarded across years by Field")

# time series: degrees awarded by sex
# wsci %>%
#   group_by(Sex, Year) %>%
#   summarise(sex_number = sum(Number)) %>%
#   ggplot(aes(x = Year, y = sex_number, color = Sex)) +
#   geom_point() + geom_line() +
#   ggtitle("Degrees awarded across years by Sex")
# 
# # time series: degrees awarded by degree type
# wsci %>%
#   group_by(Degree, Year) %>%
#   summarise(degree_number = sum(Number)) %>%
#   ggplot(aes(x = Year, y = degree_number, color = Degree)) +
#   geom_point() + geom_line() +
#   ggtitle("Degrees awarded across years by Degree")
```


```{r eval = FALSE, echo = FALSE}
# time series: degrees awarded by Field and sex
# wsci %>%
#   group_by(Field, Sex, Year) %>%
#   summarise(field_number = sum(Number)) %>%
#   ggplot(aes(x = Year, y = field_number, color = Sex)) +
#   geom_point() + geom_line() +
#   facet_wrap(~Field)+
#   ggtitle("Degrees awarded across years by Degree")
```


```{r eval = FALSE, echo = FALSE}
# time series: degrees awarded by Field and Degree
# wsci %>%
#   group_by(Field, Degree, Year) %>%
#   summarise(field_number = sum(Number)) %>%
#   ggplot(aes(x = Year, y = field_number, color = Degree)) +
#   geom_point() + geom_line() +
#   facet_wrap(~Field)+
#   ggtitle("Degrees awarded across years by Degree")
# 
# # time series: degrees awarded by Sex and Degree
# wsci %>%
#   group_by(Sex, Degree, Year) %>%
#   summarise(sex_number = sum(Number)) %>%
#   ggplot(aes(x = Year, y = sex_number, color = Sex)) +
#   geom_point() + geom_line() +
#   facet_wrap(~Degree)+
#   ggtitle("Degrees awarded across years by Degree")
# 
# # time series: degrees awarded by Sex and Field and Degree
# wsci %>%
#   group_by(Sex, Degree, Field, Year) %>%
#   summarise(sex_number = sum(Number)) %>%
#   ggplot(aes(x = Year, y = sex_number, color = Sex)) +
#   geom_point() + geom_line() +
#   facet_grid(Field~Degree)+
#   ggtitle("Degrees awarded across years by Degree")
```


```{r, echo = FALSE,message=FALSE,fig.height=10, fig.width=12, results='asis'}
wsci%>%
  ggplot(aes(x = Year,
             y = Number,
             color = Field,
             shape = Sex)) +
  geom_point(size = 3, alpha = 0.6) +
  geom_line() +
  labs(Title="Degrees by gender, field, and time") +
  facet_grid(~Degree + Sex, scale = "free")
```


```{r, echo = FALSE,message=FALSE,fig.height=10, fig.width=12, results='asis'}
wsci %>%
  ggplot(aes(x = Year,
             y = Number,
             fill = Field,
             shape = Sex)) +
  geom_bar(position="stack", stat="identity") +
  labs(Title="Degrees by gender, field, and time") +
  facet_grid(~Degree + Sex, scale = "free")
```

Do the number of degrees change by gender, field, and time? --> **Females appear to have more degrees overall at the BS and MS level, but Males have more PhDs in STEM fields, compared to women. Males also have more STEM MS degrees than Females.**

## Women in Data Science

Finally, is there evidence showing that women are underrepresented in data science? Data science is an interdisciplinary field of computer science, math, and statistics. You may include year and/or degree.

```{r echo = FALSE, message=FALSE,fig.height=6, fig.width=12, results='asis'}

# sex and field
wsci %>%
  filter(Field %in% c("Computer sciences", "Mathematics and statistics")) %>%
  group_by(Field, Sex) %>%
  summarise(All_number = sum(Number)) %>%
  ggplot(aes(x = Sex, y = All_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label =All_number), vjust = -.5)  +
  # stat_compare_means(method = "t.test") +
  facet_grid(~Field, scales = "free_y") +
  ggtitle("Degrees granted in Data science by sex") 
```


```{r, echo = FALSE,message=FALSE,fig.height=10, fig.width=12, results='asis'}
# Sex, Field, Degree
wsci %>%
  filter(Field %in% c("Computer sciences", "Mathematics and statistics")) %>%
  group_by(Field, Sex, Degree) %>%
  summarise(All_number = sum(Number)) %>%
  ggplot(aes(x = Sex, y = All_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label =All_number), vjust = -.5)  +
  facet_grid(Degree~Field, scales = "free_y") +
  ggtitle("Degrees granted in Data science by sex")
```


```{r, echo = FALSE, message=FALSE,fig.height=10, fig.width=12, results='asis'}
# Sex, Field, Degree, Time
wsci %>%
  filter(Field %in% c("Computer sciences", "Mathematics and statistics")) %>%
  group_by(Field, Sex, Degree, Year) %>%
  summarise(All_number = sum(Number)) %>%
  ggplot(aes(x = Year, y = All_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Degree~Field, scales = "free_y") +
  ggtitle("Degrees granted in Data science by sex")

```

**Overall, we believe there is enough graphical evidence that women are underrepresented in data science related fields. In computer science, that disparity is ony getting worse with time. Overall, there are less people in math and statistics at the BS and MS level; however, with more oerall degress in math a the PhD level, women still get about half the amount of math PhDs as men.**




```{r}
# # social science
# 
# # Sex, Field
# wsci %>%
#   filter(Field %in% c("Psychology", "Social sciences")) %>%
#   group_by(Field, Sex) %>%
#   summarise(All_number = sum(Number)) %>%
#   ggplot(aes(x = Sex, y = All_number, fill = Sex)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   facet_grid(~Field, scales = "free_y") +
#   ggtitle("Degrees granted in Social science by sex across degree and SE")
# 
# # Sex, Field, Degree
# wsci %>%
#   filter(Field %in% c("Psychology", "Social sciences")) %>%
#   group_by(Field, Sex, Degree) %>%
#   summarise(All_number = sum(Number)) %>%
#   ggplot(aes(x = Sex, y = All_number, fill = Sex)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   facet_grid(Field~Degree, scales = "free_y") +
#   ggtitle("Degrees granted in Social science by sex across degree and SE")
# 
# # Sex, Field, Degree, Time
# wsci %>%
#   filter(Field %in% c("Psychology", "Social sciences")) %>%
#   group_by(Field, Sex, Degree,Year) %>%
#   summarise(All_number = sum(Number)) %>%
#   ggplot(aes(x = Year, y = All_number, fill = Sex)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   facet_grid(Field~Degree, scales = "free_y") +
#   ggtitle("Degrees granted in Social science by sex across degree and SE")


```

## Final brief report

Summarize your findings focusing on answering the questions regarding if we see consistent patterns that more males pursue science-related fields. Any concerns with the data set? How could we improve on the study?

<<<<<<< HEAD
In general, there are more people overall in Non-S&E fields, in which there are more women. However, we consistently see that there are more men in the S&E fields. The proportion of non s&e fields and the degree types is relatively the same, but more variability in the s&e degrees. males and females obtain about the same science BS degrees (females slightly more), but males have more science MS and PhDs.Females appear to have more degrees overall at the BS and MS level, but Males have more PhDs in STEM fields, compared to women. Males also have more STEM MS degrees than Females.

We believe there is enough graphical evidence that women are underrepresented in data science related fields. In computer science, that disparity is ony getting worse with time. Overall, there are less people in math and statistics at the BS and MS level; however, with more oerall degress in math a the PhD level, women still get about half the amount of math PhDs as men. 

We can improve on this study by also including people who pursued stem degrees but did not follow through, o2 switched to another field. 
=======


**There are more people overall in Non-S&E fields, in which there are more women. However, there are more men in the S&E fields from these plots.**

**The proportion of non s&e fields and the degree types is relatively the same, but more variability in the s&e degrees. males and females obtain about the same science BS degrees (females slightly more), but males have more science MS and PhDs.**

**Females appear to have more degrees overall at the BS and MS level, but Males have more PhDs in STEM fields, compared to women. Males also have more STEM MS degrees than Females.**

**We believe there is enough graphical evidence that women are underrepresented in data science related fields. In computer science, that disparity is ony getting worse with time. Overall, there are less people in math and statistics at the BS and MS level; however, with more oerall degress in math a the PhD level, women still get about half the amount of math PhDs as men.**

**We do see more males represented in the dataset, but one concern is that this is only capturing individuals with degrees granted in these fields, and not actually those who intiially pursue those degrees. We hypothesize that given culture, environment, and systemic factors, a measurable number of women pursuing STEM fields may not end up staying within them through conferall of a degree. So while women are less represetned in the data, there is not enough evidence to condlude that women are less interested in STEM fields in geenral.**




>>>>>>> 6522559915f2292cadc2669cd099f04ccbe6341f

<!-- ## Appendix

<!-- To help out, we have included some R-codes here as references. You should make your own chunks filled with texts going through each items listed above. Make sure to hide the unnecessary outputs/code etc.  -->

<!-- 1. Clean data -->

<!-- ```{r data wrangling, echo = FALSE, warning = FALSE} -->
<!-- # For the demonstration purpose, we show this R-chunk by taking echo=TRUE -->
<!-- # In your final report you should hide all the R-chunks to keep your report flowing well. -->
<!-- wsci <- read_excel("WomenData_06_16.xlsx") -->
<!-- names(wsci) -->
<!-- head(wsci) -->
<!-- #change names -->
<!-- wsci %<>%  -->
<!--   rename(Field = 'Field and sex') -->
<!-- # set the field, degree and sex as factors -->
<!-- wsci %<>%  -->
<!--   mutate( Field = as.factor(Field)) -->
<!-- ``` -->


<!-- ```{r, echo=FALSE} -->
<!-- # wsci %<>% -->
<!-- #   rename(Field = "Field and sex", -->
<!-- #          Number = "Degrees Awarded") %>% -->
<!-- #   mutate(Field = as.factor(Field), -->
<!-- #          Degree = as.factor(Degree), -->
<!-- #          Sex = as.factor(Sex)) -->

<!-- ``` -->


<!-- 2. A number of sample analyses  -->

<!-- ```{r eval = FALSE, echo = FALSE} -->
<!-- wsci %>%  # to get the average number of ppl by gender -->
<!--   group_by(Field, Sex) %>% -->
<!--   summarise(deg = mean(Number)) -->

<!-- wsci %>% -->
<!--   filter(Year == 2007) %>% -->
<!--   ggplot(aes(x = Field, y = Number, fill = Sex)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   facet_grid(Degree~., scales = "free_y") + -->
<!--   theme(axis.text.x = element_text(angle = 30, hjust = 1)) + -->
<!--   ggtitle("Degrees granted across fields by degree and gender")  -->

<!-- wsci %>% -->
<!--   mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>% -->
<!--   group_by(SE, Sex) %>% -->
<!--   summarise(SE_number = sum(Number)) %>% -->
<!--   ggplot(aes(x = SE, y = SE_number, fill = Sex)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   theme(axis.text.y = element_text(angle = 60)) + -->
<!--   ggtitle("Degrees granted by S&E vs non-S&E by gender") -->

<!-- wsci %>% -->
<!--   mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>% -->
<!--   group_by(SE, Sex, Year) %>% -->
<!--   summarise(SE_number = sum(Number)) %>% -->
<!--   group_by(SE, Year) %>% -->
<!--   mutate(ratio = SE_number / sum(SE_number)) %>% -->
<!--   filter(Sex == "Female") %>% -->
<!--   ggplot(aes(x = Year, y = ratio, color = SE)) + -->
<!--   geom_point() + geom_line() + -->
<!--   ggtitle("Female proportion in SE/non-SE across year") -->

<!-- wsci %>% -->
<!--   mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>% -->
<!--   group_by(SE, Sex, Year, Degree) %>% -->
<!--   summarise(SE_number = sum(Number)) %>% -->
<!--   group_by(SE, Year, Degree) %>% -->
<!--   mutate(ratio = SE_number / sum(SE_number)) %>% -->
<!--   filter(Sex == "Female") %>% -->
<!--   ggplot(aes(x = Year, y = ratio, color = SE)) + -->
<!--   geom_point() + geom_line() + -->
<!--   facet_grid(~Degree)+ -->
<!--   ggtitle("Female proportion in SE/non-SE across year by degree") -->


<!-- wsci %>% -->
<!--   mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>% -->
<!--   group_by(SE, Sex, Year, Degree) %>% -->
<!--   summarise(SE_number = sum(Number)) %>% -->
<!--   ggplot(aes(x = Year, y = SE_number, fill = Sex)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   facet_grid(SE~Degree, scales = "free_y") + -->
<!--   ggtitle("Degrees granted by sex, degree and SE") -->


<!-- wsci %>% -->
<!--   mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>% -->
<!--   group_by(SE, Sex, Year, Degree) %>% -->
<!--   summarise(SE_number = sum(Number)) %>% -->
<!--   ggplot(aes(x = Year, y = SE_number, fill = Sex)) + -->
<!--   geom_bar(stat = "identity", position = "fill") + -->
<!--   facet_grid(SE~Degree, scales = "free_y") + -->
<!--   ggtitle("Degrees granted proportion by sex across degree and SE") -->


<!-- wsci %>% -->
<!--   filter(Field %in% c("Computer sciences", "Mathematics and statistics")) %>% -->
<!--   ggplot(aes(x = Year, y = Number, fill = Sex)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   facet_grid(Field~Degree, scales = "free_y") + -->
<!--   ggtitle("Degrees granted pr option by sex across degree and SE") -->


<!-- wsci %>% -->
<!--   ggplot(aes(x = Year, y = Number, fill = Sex)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   facet_grid(Field~Degree, scales = "free_y") + -->
<!--   ggtitle("Degrees granted proportion by sex across degree and SE") -->
<!-- ``` -->




# Case study 3: Major League Baseball

We would like to explore how payroll affects performance among Major League Baseball teams. The data is prepared in two formats record payroll, winning numbers/percentage by team from 1998 to 2014. 

Here are the datasets:

-`MLPayData_Total.csv`: wide format
-`baseball.csv`: long format

Feel free to use either dataset to address the problems. 

```{r read data}
datapay <- read.csv("data/MLPayData_Total.csv", header=T, stringsAsFactors = FALSE) 
head(datapay)

baseball <- read.csv("data/baseball.csv", header = TRUE, stringsAsFactors = F)
names(baseball)
str(baseball)
summary(baseball)
baseball %>% arrange(forcats::fct_reorder(team, -win_pct, .fun = max))
```

## EDA: Relationship between payroll changes and performance

Payroll may relate to performance among ML Baseball teams. One possible argument is that what affects this year's performance is not this year's payroll, but the amount that payroll increased from last year. Let us look into this through EDA. 

Create increment in payroll

a). To describe the increment of payroll in each year there are several possible approaches. Take 2013 as an example:

    - option 1: diff: payroll_2013 - payroll_2012
    - option 2: log diff: log(payroll_2013) - log(payroll_2012)

Explain why the log difference is more appropriate in this setup.

The log difference is appropriate to use in this step because it will scale the differences in a way that is more comparable across teams given the high variability of the year-to-year differences. This is especially important since the pay scale for all the teams is also very different. 



b). Create a new variable `diff_log=log(payroll_2013) - log(payroll_2012)`. Hint: use `dplyr::lag()` function.

```{r}
baseball %>%
  group_by(team) %>%
  mutate(diff_log =log(payroll) - log(lag(payroll, default = payroll[1], order_by = team))) %>%
  head()
```

c). Create a long data table including: team, year, diff_log, win_pct

```{r}
baseball_long <- baseball %>%
  group_by(team) %>%
  mutate(diff_log =log(payroll) - log(lag(payroll, default = payroll[1], order_by = team))) %>%
  select(., c("team", "year", "diff_log", "win_pct"))
head(baseball_long)
```

## Exploratory questions

a). Which five teams had highest increase in their payroll between years 2010 and 2014, inclusive?

The Los Angeles Dodgers, Miami Marlins, Houston Astros, Kansas City Royals, and the Texas Rangers

```{r, eval=TRUE, results='asis'}
baseball_long %>% 
  filter(year >= 2010 & year <=2014) %>%
  arrange(desc(diff_log)) %>% head(5) %>% kable(caption = "Top Five teams with the highest increase in their payroll between years 2010 and 2014, inclusive")
```


b). Between 2010 and 2014, inclusive, which team(s) "improved" the most? That is, had the biggest percentage gain in wins?

The Arizona Diamondbacks, Boston Red Sox, Houston Astros, Cleveland Indians, and Baltimore Orioles

```{r eval=TRUE, results='asis'}
baseball_long %>%
  group_by(team) %>%
  mutate(diff_log_win =log(win_pct) - log(lag(win_pct, default = win_pct[1], order_by = team))) %>% 
  filter(year >= 2010 & year <=2014) %>%
  arrange(desc(diff_log_win)) %>%  head(5) %>% kable(caption = "Top Five teams with the biggest percentage gain in wins between years 2010 and 2014, inclusive")

```

## Do log increases in payroll imply better performance? 

```{r, warning=FALSE}
baseball_long_plot1 <- baseball %>%
  group_by(team) %>%
  mutate(diff_log =log(payroll) - log(lag(payroll, default = payroll[1], order_by = team))) %>%
  select(., c("team", "year", "diff_log", "win_pct")) %>%
  ggplot(aes(x = diff_log, y = win_pct)) + 
  geom_point(aes(color = team), size = 3) + 
  stat_poly_line() +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*"))) +
  labs(title = "MLB Team's Win Percentage  vs. Payroll increase", 
       x = "Log yearly Payroll Increase", 
       y = "Win Percentage") +
  theme_bw() +
  theme(legend.position = "none")

baseball_long_plot1
```


Log increases in payroll have a very weak linear relationship to performance overall. 

```{r, warning=FALSE}
baseball_long_plot2 <- baseball %>%
  group_by(team) %>%
  mutate(diff_log =log(payroll) - log(lag(payroll, default = payroll[1], order_by = team))) %>%
  select(., c("team", "year", "diff_log", "win_pct")) %>%
  ggplot(aes(x = diff_log, y = win_pct)) + 
  geom_point(aes(color = team), size = 3) + 
  stat_poly_line() +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*"))) +
  labs(title = "MLB Team's Win Percentage  vs. Payroll increase", 
       x = "Log yearly Payroll Increase", 
       y = "Win Percentage") +
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap(~team)

baseball_long_plot2
```






Is there evidence to support the hypothesis that higher increases in payroll on the log scale lead to increased performance? Pick up a few statistics, accompanied with some data visualization, to support your answer.  --> **All R^2 are less than 0.5 indicating a weak linear relationship between team-to-team log increase in payroll and their performance.**




## Comparison

Which set of factors are better explaining performance? Yearly payroll or yearly increase in payroll? What criterion is being used? 

```{r}
baseball2 <- baseball %>%
  group_by(team) %>%
  mutate(diff_log =log(payroll) - log(lag(payroll, default = payroll[1], order_by = team)))

fit = lm(win_pct ~ payroll + diff_log, data = baseball2)
summary(fit)

```

**This linear model shows that raw payroll more significantly predicts performance that log payroll, although the R^2 overall is still quite weak.** 



